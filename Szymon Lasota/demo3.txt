Demo 3: Semi ELT with PBI refresh (on Sample AdventureWorksLT)

Create report on SalesOrderDetail with UntiPrice

Publish

Grant dataset credentials auth to database

check report

get token for credential
az login --allow-no-subscriptions
az account get-access-token --resource "https://analysis.windows.net/powerbi/api" --query "accessToken" -o tsv

prepr URL to dataset (get datasetid from portal)
https://api.powerbi.com/v1.0/myorg/datasets/c67fe953-0ed9-45e5-9df7-651a8c4bd02a/refreshes
check api manually
https://learn.microsoft.com/en-us/rest/api/power-bi/datasets/refresh-dataset#code-try-0

-- create database scoped credential
if exists(select * from sys.database_scoped_credentials where [name] = 'https://api.powerbi.com/v1.0/myorg/datasets/c67fe953-0ed9-45e5-9df7-651a8c4bd02a/refreshes') begin
    drop database scoped credential [https://api.powerbi.com/v1.0/myorg/datasets/c67fe953-0ed9-45e5-9df7-651a8c4bd02a/refreshes];
end
create database scoped credential [https://api.powerbi.com/v1.0/myorg/datasets/c67fe953-0ed9-45e5-9df7-651a8c4bd02a/refreshes]
with identity = 'HTTPEndpointHeaders', secret = '{"Authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ii1LSTNROW5OUjdiUm9meG1lWm9YcWJIWkdldyIsImtpZCI6Ii1LSTNROW5OUjdiUm9meG1lWm9YcWJIWkdldyJ9.eyJhdWQiOiJodHRwczovL2FuYWx5c2lzLndpbmRvd3MubmV0L3Bvd2VyYmkvYXBpIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvNDk2YTgzMDktOTRmMy00OGI5LThjMDAtODA1MmNiZTgwYWQxLyIsImlhdCI6MTY4MzU3ODA3NiwibmJmIjoxNjgzNTc4MDc2LCJleHAiOjE2ODM1ODM1ODgsImFjY3QiOjAsImFjciI6IjEiLCJhaW8iOiJBVlFBcS84VEFBQUFKK0Z4clErTWVZQjdTaUk2QlU4M1VVQ1V2Tkx1OHpUUW1Cc0dENENBVWN3OVdWWVFBSDRXb2hoTUdCWHFmNFJhczdXOEROVm1jQWQvS2FHczZSb1JMTUUwYWFVNEV5SmtFNkVxbzkyL3BsWT0iLCJhbXIiOlsicHdkIiwicnNhIiwibWZhIl0sImFwcGlkIjoiMDRiMDc3OTUtOGRkYi00NjFhLWJiZWUtMDJmOWUxYmY3YjQ2IiwiYXBwaWRhY3IiOiIwIiwiZGV2aWNlaWQiOiJjMjk0YmMzOS00NjI0LTQ4MjctODg2OC1jNzk3OWM1NjlhOGEiLCJmYW1pbHlfbmFtZSI6Ikxhc290YSIsImdpdmVuX25hbWUiOiJTenltb24iLCJpcGFkZHIiOiIxOTMuMjM5LjU3LjcxIiwibmFtZSI6IlN6eW1vbiBMYXNvdGEiLCJvaWQiOiJkNDUyODliMS01MGY4LTQyZDQtYThmNC1hMDgxZGVkZjk4NzMiLCJwdWlkIjoiMTAwMzIwMDEzRUNGMDJGMyIsInB3ZF91cmwiOiJodHRwczovL3BvcnRhbC5taWNyb3NvZnRvbmxpbmUuY29tL0NoYW5nZVBhc3N3b3JkLmFzcHgiLCJyaCI6IjAuQVlFQUNZTnFTZk9VdVVpTUFJQlN5LWdLMFFrQUFBQUFBQUFBd0FBQUFBQUFBQUNCQU9FLiIsInNjcCI6InVzZXJfaW1wZXJzb25hdGlvbiIsInN1YiI6InlBQllDcWpleG9KNUNIRk5TWjZReFJsVFBlSXNpWWxUeWpmTUI3ektIZ2MiLCJ0aWQiOiI0OTZhODMwOS05NGYzLTQ4YjktOGMwMC04MDUyY2JlODBhZDEiLCJ1bmlxdWVfbmFtZSI6InNoaW1vbkBhcmNoYWx2Lm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6InNoaW1vbkBhcmNoYWx2Lm9ubWljcm9zb2Z0LmNvbSIsInV0aSI6InhoTEJKMlRJclVXSDQ0QnBwVnNsQUEiLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjYyZTkwMzk0LTY5ZjUtNDIzNy05MTkwLTAxMjE3NzE0NWUxMCIsImI3OWZiZjRkLTNlZjktNDY4OS04MTQzLTc2YjE5NGU4NTUwOSJdLCJ4bXNfY2MiOlsiQ1AxIl0sInhtc19wbCI6ImVuLVVTIn0.kLxSS72uyxHtcYsbhjVX4Lefm70NEgPlAY0XvN_r1eHW4_JKvXb_zAsr5igdgA9aI-YpHN5hRO1Lu4xmlBe0VhnU2Jb9TQkYZVXZD7feuVbHmzHvNCugB6gH1EIds5WonFgDrvCzUBU56j0fC7TUvEsdqLZ-C6bT4GuCCU-cXohAGzqQ98ML_Li-58GeJLd948_QSZbyfaU94-ibL2XqLKuA6FQkUvcQdSAJws6TreJVtCrSNNao5F6Ezgp5XEdMysmOvirujt5w0RMiQ06D6wdFKbmK7Qo8gqf-1hKpXZOiv0olqOx7qSDnyn3oiTKJH22PrFSgYxoM213v4WG1mA.eyJhdWQiOiJodHRwczovL2FuYWx5c2lzLndpbmRvd3MubmV0L3Bvd2VyYmkvYXBpIiwiaXNzIjoiaHR0cHM6Ly9zdHMud2luZG93cy5uZXQvNDk2YTgzMDktOTRmMy00OGI5LThjMDAtODA1MmNiZTgwYWQxLyIsImlhdCI6MTY4MzU3MjQyOSwibmJmIjoxNjgzNTcyNDI5LCJleHAiOjE2ODM1NzcyODYsImFjY3QiOjEsImFjciI6IjEiLCJhaW8iOiJBWVFBZS84VEFBQUFVV3pLZkRtTi9rbEpnVDlHNWVNSlBVMmRHZUdtbjJqcjJOMHRxZW50b1lTUk1RcTErUEdxdVl6cjBoUmdvMVNaTk9JS1BXbHl6NEkxa0s1TGo3VzQzZzB0VUVaMHYxbFNMVzlGVzAwbmZZc3V5MnFCRkV3dHAyclc1R0dXYzNjNEtNdCs4SldySUY4QWxxSFFlNmdLSHRmR056OXUvSlNKdHpuOWVWSng3UHc9IiwiYWx0c2VjaWQiOiIxOmxpdmUuY29tOjAwMDNCRkZEQUREMzFCOEIiLCJhbXIiOlsicHdkIiwibWZhIl0sImFwcGlkIjoiMThmYmNhMTYtMjIyNC00NWY2LTg1YjAtZjdiZjJiMzliM2YzIiwiYXBwaWRhY3IiOiIwIiwiZW1haWwiOiJhcmNoYWx2QGdtYWlsLmNvbSIsImZhbWlseV9uYW1lIjoiTGFzb3RhIiwiZ2l2ZW5fbmFtZSI6IlN6eW1vbiIsImlkcCI6ImxpdmUuY29tIiwiaXBhZGRyIjoiMTkzLjIzOS41Ny43MSIsIm5hbWUiOiJTenltb24gTGFzb3RhIiwib2lkIjoiNzdjNWFhYWYtMjlmNi00N2Y0LTkyNjItMzAxZWVmMWRjNTlkIiwicHVpZCI6IjEwMDMyMDAxRUE2OTYzNkIiLCJyaCI6IjAuQVlFQUNZTnFTZk9VdVVpTUFJQlN5LWdLMFFrQUFBQUFBQUFBd0FBQUFBQUFBQUNCQUlrLiIsInNjcCI6IkFwcC5SZWFkLkFsbCBDYXBhY2l0eS5SZWFkLkFsbCBDYXBhY2l0eS5SZWFkV3JpdGUuQWxsIENvbnRlbnQuQ3JlYXRlIERhc2hib2FyZC5SZWFkLkFsbCBEYXNoYm9hcmQuUmVhZFdyaXRlLkFsbCBEYXRhZmxvdy5SZWFkLkFsbCBEYXRhZmxvdy5SZWFkV3JpdGUuQWxsIERhdGFzZXQuUmVhZC5BbGwgRGF0YXNldC5SZWFkV3JpdGUuQWxsIEdhdGV3YXkuUmVhZC5BbGwgR2F0ZXdheS5SZWFkV3JpdGUuQWxsIFBpcGVsaW5lLkRlcGxveSBQaXBlbGluZS5SZWFkLkFsbCBQaXBlbGluZS5SZWFkV3JpdGUuQWxsIFJlcG9ydC5SZWFkLkFsbCBSZXBvcnQuUmVhZFdyaXRlLkFsbCBTdG9yYWdlQWNjb3VudC5SZWFkLkFsbCBTdG9yYWdlQWNjb3VudC5SZWFkV3JpdGUuQWxsIFRlbmFudC5SZWFkLkFsbCBUZW5hbnQuUmVhZFdyaXRlLkFsbCBVc2VyU3RhdGUuUmVhZFdyaXRlLkFsbCBXb3Jrc3BhY2UuUmVhZC5BbGwgV29ya3NwYWNlLlJlYWRXcml0ZS5BbGwiLCJzaWduaW5fc3RhdGUiOlsia21zaSJdLCJzdWIiOiJjZEFDRHVSbDc1ZTduVkNPdXljeThuTmkxLTdWYXdwWDVMQ0lOUi1XcF9JIiwidGlkIjoiNDk2YTgzMDktOTRmMy00OGI5LThjMDAtODA1MmNiZTgwYWQxIiwidW5pcXVlX25hbWUiOiJsaXZlLmNvbSNhcmNoYWx2QGdtYWlsLmNvbSIsInV0aSI6InEwdVpIcnUzblVpUXFudXlBWnNBQUEiLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjYyZTkwMzk0LTY5ZjUtNDIzNy05MTkwLTAxMjE3NzE0NWUxMCIsIjEzYmQxYzcyLTZmNGEtNGRjZi05ODVmLTE4ZDNiODBmMjA4YSJdfQ.Q5EUbXh8MJUlYwvGMc1RVBUT4oBPcIlWRxBLiFz_RRm9qtqWPoq3KOndRfcwThg7kBaBL9hIYrX-QM47U2DpF5t-UCZw2EAI-YChEu8xGQ5sYK3Y59DwVatjuUPHp6RdLZZLSo3tssR61IEGOaraZ5XuXagHEIjrwYHBLNYKt2sn9cM97pfZF8eSmxikAAMM9yP-Hr9YhK1Cw1PmNFtbs2mhHmiUMNElSWAqE7hnv5bxwEnAhUs88sMMoGWCwE0EUkjnyYPoQG_PPwchGahagB1dU8bIwznPAIQ2a0r5KUlXAf4yeWMjG7A3XgAJxgbT80U88_GjyYB6rlXwSdDaNg"}';
go

SELECT [ProductID]
      ,[UnitPrice]
  FROM [SalesLT].[SalesOrderDetail]
  
UPDATE [SalesLT].[SalesOrderDetail]
SET UnitPrice = UnitPrice*2

declare @url nvarchar(4000) = N'https://api.powerbi.com/v1.0/myorg/datasets/c67fe953-0ed9-45e5-9df7-651a8c4bd02a/refreshes';

declare @ret int, @response nvarchar(max);

exec @ret = sys.sp_invoke_external_rest_endpoint 
	@method = 'POST',
	@url = @url,
	@credential = [https://api.powerbi.com/v1.0/myorg/datasets/c67fe953-0ed9-45e5-9df7-651a8c4bd02a/refreshes],
	@response = @response output;
select 
    @ret as ReturnCode,     
    json_query(@response, '$.response') as Response,
    json_query(@response, '$.result') as Result;	
	